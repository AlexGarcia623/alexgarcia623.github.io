<!DOCTYPE html>
<html>
<link rel="stylesheet" href="style.css">

<meta http-equiv='cache-control' content='no-cache'> 
<meta http-equiv='expires' content='0'> 
<meta http-equiv='pragma' content='no-cache'>

<script src="scripts.js"></script>

<head>
<style>
* {
  box-sizing:border-box;
}
.column {
  float:left;
  width:50%;
}

.row:after {
  contents: "";
  display: table;
  clear: both;
}

p {
  color:steelblue;
  font-size:14pt;
}

h1 {
  font-size:30pt;
}

h2 {
  font-size:18pt;
}

button {
  background-color:black;
  color:steelblue;
  border: 1px solid tomato;
  padding: 8px;
  font-size: 12pt;
}

button:hover {
  background-color:steelblue;
  color:black;
}

input:hover {
  background-color:steelblue;
  color:black;
}

.column3 {
  float:left;
  width:33%;
}

img:hover {
  width=110%;
}
#canvas {
  border: 1px solid black;
}

</style>

<script src="https://cdn.plot.ly/plotly-2.11.1.min.js"></script>
<script src="plotly-2.11.1.min.js"></script>

</head>


<body>

<div class="body">

  <h1>Flow Of Energy Out Of The Sun 2</h2> 

  <p style="color:white;">Welcome to the flow of energy out of the sun 2! This second experiment is to understand the emission of Fraunhofer lines. Random walk part of this is cool, but necessary...? Ehh not entirely sure. Slows down the process, maybe just keep for the random walk part.</p>

  <canvas class="center" id="canvas" height="500" width="750"></canvas> <br>
  <input type="button" onclick="start()" value="Start!" class="center"/>
  <input type="button" onclick="stop()" value="Stop" class="center"/>
  <h2>Number of Escaped Photons:</h2>
  <p id="display"> </p>
  <p id="finished" style="color:orange;font-size:25pt;"> </p>
  <p id="previous0"> </p>
  <p id="previous1"> </p>
  <p id="previous2"> </p>
  <p id="previous3"> </p>
  <p id="previous4"> </p>

  <div id="myPlot" style="width:100%" class="center"></div>



</body>

<script>
    // Based on code found here: https://gist.github.com/hacknightly/fd609abe5a7e15e223a823ee6e0724c8
    let x = 375;
    let y = 250;
    var counter = document.querySelector('canvas');
    var number = 0;
    //var requestID;
 
    var WLmin = 350;
    var WLmax = 700;
    var WLlength = WLmax - WLmin + 1;

    var wavelengths = new Array(WLlength);
    var yvals = new Array(WLlength);
    var counts = new Array(WLlength); 
    var colors = new Array(WLlength);

    for (var i=0; i<WLlength; ++i) {
      counts[i] = 0;
    };
    for (var i=0; i<WLlength; ++i) {
      wavelengths[i] = WLmin + i;
    };
    for (var i=0; i<WLlength; ++i) {
      yvals[i] = 1;
    };

    var Lines = [393,397,410,423,431,434,438,486,517,527,590,656,686];
    var negative = [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];

    function randomWavelength(min, max) {
      var lambda = parseInt(Math.random() * (max - min) + min);
      if (Lines.includes(lambda)) { 
        lambda = randomWavelength(min,max)
      }
      return lambda;
    }

    function random(min, max) {
      return Math.random() * (max - min) + min;
    }

    function init() {
      requestID = window.requestAnimationFrame(draw);
      document.getElementById("display").innerHTML = number;
    }
   
    function draw() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');    

      ctx.strokeStyle = 'yellow';
      ctx.beginPath();
      ctx.arc(375, 250, 200, 0, 2 * Math.PI);
      ctx.lineWidth = 3;
      ctx.stroke();
      ctx.beginPath();
      ctx.strokeStyle = 'red';
      ctx.arc(375, 250, 15, 0, 2 * Math.PI);
      ctx.stroke();
      ctx.beginPath();
      ctx.strokeStyle = 'orange';
      ctx.arc(375, 250, 150, 0, 2 * Math.PI);
      ctx.stroke();

      ctx.strokeStyle = 'white';
      ctx.beginPath();
      ctx.moveTo(x, y);
      if ( ((x-375)**2 + (y-250)**2)**(1/2) < 15 ) {
        x += random(-30, 30);
        y += random(-30, 30);
      } else if ( ((x-375)**2 + (y-250)**2)**(1/2) < 150 ) {
        x += random(-150, 150);
        y += random(-150, 150);
      } else {
        x += random(-30, 30);
        y += random(-30, 30);
      }
      ctx.lineWidth = 2;
      ctx.lineTo(x, y);
      ctx.stroke();
      if ( ((x-375)**2 + (y-250)**2)**(1/2) > 200 ) {
        var WL = WLChecker();
        
        document.getElementById("display").innerHTML = WL
        
        restart();
      }
      else {
        requestID = window.requestAnimationFrame(draw);
      }
      return;
    }
    
    function WLChecker() {
      var WL = randomWavelength(WLmin, WLmax+1);
      let index = wavelengths.indexOf(WL);
      if (counts[index] < 2) {
        counts[index]++;
      } else {
        WLChecker();
      }
      return WL;
    }

    function start() {
	const canvas = document.getElementById('canvas');
	const context = canvas.getContext('2d');

	context.clearRect(0, 0, canvas.width, canvas.height);
        	x = 375;
        	y = 250;
        	number = 0;
        	document.getElementById("display").innerHTML = "";
      	plot();
	init();
    }

    function restart() {
	number++;
	const canvas = document.getElementById('canvas');
	const context = canvas.getContext('2d');

	context.clearRect(0, 0, canvas.width, canvas.height);

	x = 375;
	y = 250;
	plot();
	init();
    }
    
    function stop() {
      cancelAnimationFrame(requestID);

      plot();
      
      for (var i=0; i<WLlength; ++i) {
        counts[i] = 0
      };
      for (var i=0; i<WLlength; ++i) {
         wavelengths[i] = WLmin + i;
      };
      for (var i=0; i<WLlength; ++i) {
         colors[i] = "";
      }; 

    }
    
    var trace1 = {
      x: Lines,
      y: negative,
      mode: 'markers',
      type: 'scatter'
    };

    var trace2 = {
      x:wavelengths,
      y:yvals,
      marker: {color:colors},
      type:"bar"
    };
   
    var layout= {
      plot_bgcolor:"black",
      paper_bgcolor:"black",
      yaxis: {
        autorange: true,
        showgrid: false,
        zeroline: false,
        showline: false,
        autotick: true,
        ticks: '',
        showticklabels: false
      }
    }
  
    var config = {
      modeBarButtonsToRemove: ['pan2d','lasso2d','select2d','autoScale2d']
    }

    var data = [trace2]

    function plot() {
      for (var i=0; i<WLlength; ++i) {
        colors[i] = wavelengthToColor(wavelengths[i],counts[i]);
      };
      if (number == 676) {
        document.getElementById('finished').innerHTML = "Finished!";
      }
      Plotly.newPlot("myPlot", data, layout, config);
    }
    Plotly.newPlot("myPlot", data, layout,config);

    // takes wavelength in nm and returns an rgba value
    // Taken from: https://scienceprimer.com/javascript-code-convert-light-wavelength-color
    function wavelengthToColor(wavelength,count) {
        var r,
            g,
            b,
            alpha,
            colorSpace,
            wl = wavelength,
            gamma = 1;
 
 
        if (wl >= 350 && wl < 440) {
            R = -1 * (wl - 440) / (440 - 350);
            G = 0;
            B = 1;
       } else if (wl >= 440 && wl < 490) {
           R = 0;
           G = (wl - 440) / (490 - 440);
           B = 1;  
        } else if (wl >= 490 && wl < 510) {
            R = 0;
            G = 1;
            B = -1 * (wl - 510) / (510 - 490);
        } else if (wl >= 510 && wl < 580) {
            R = (wl - 510) / (580 - 510);
            G = 1;
            B = 0;
        } else if (wl >= 580 && wl < 645) {
            R = 1;
            G = -1 * (wl - 645) / (645 - 580);
            B = 0.0;
        } else if (wl >= 645 && wl <= 780) {
            R = 1;
            G = 0;
            B = 0;
        } else {
            R = 0;
            G = 0;
            B = 0;
        }
 
        // intensty is lower at the edges of the visible spectrum.
        //if (wl > 780 || wl < 380) {
        //    alpha = 0;
        //} else if (wl > 700) {
        //    alpha = (780 - wl) / (780 - 700);
        //} else if (wl < 420) {
        //    alpha = (wl - 380) / (420 - 380);
        //} else {
        //    alpha = 1;
        //}
 
        alpha = 0 + (count/2);
        colorSpace = "rgba(" + (R * 100) + "%," + (G * 100) + "%," + (B * 100) + "%, " + alpha + ")";
 
        // colorSpace is an array with 5 elements.
        // The first element is the complete code as a string.  
        // Use colorSpace[0] as is to display the desired color.  
        // use the last four elements alone or together to access each of the individual r, g, b and a channels.  
       
        return colorSpace;
       
    }

  </script>

</html>