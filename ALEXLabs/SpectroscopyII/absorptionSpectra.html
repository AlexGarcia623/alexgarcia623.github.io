<!DOCTYPE html>
<html>
<link rel="stylesheet" href="../ALEX.css">

<meta http-equiv='cache-control' content='no-cache'> 
<meta http-equiv='expires' content='0'> 
<meta http-equiv='pragma' content='no-cache'>

<meta name="viewport" content="width=device-width, initial-scale=1">

<head>
<style>
* {
  box-sizing:border-box;
}
.column {
  float:left;
  width:50%;
}

.row:after {
  contents: "";
  display: table;
  clear: both;
}

.column3 {
  float:left;
  width:33%;
}


h1 {
  color:green;
}

h2 {
  color:green;
}

p, a {
  color:lightgreen;
}


#canvas {
  border: 1px solid black;
  width: 50%;
}

.slidecontainer {
  width: 100%;
}

.slider {
  -webkit-appearance: none;
  border: 2px darkgreen solid;
  width: 100%;
  height: 25px;
  background: lightgreen;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover {
  opacity: 1;
  background:darkgreen;
  border: 2px lightgreen solid;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  cursor: pointer;
  background:white;
}

.slider::-moz-range-thumb {
  width: 35px;
  height: 35px;
}

input {
  color:lightgreen;
  font-size:min(max(18pt, 2vw), 22pt);
  border:2px darkgreen solid;
}

input:hover {
  color:darkgreen;
  background:lightgreen;
}
</style>

<script src="https://cdn.plot.ly/plotly-2.11.1.min.js"></script>
<script src="plotly-2.11.1.min.js"></script>

</head>

<header>
  <title>Spectroscopy II</title>
  <button class = "button biggerButton" onclick="SpecHome()">Main Menu</button>
</header>

<script>
  function SpecHome() {
    window.open('AstronomicalSpectroscopyII.html','_self');
  }
</script>

<body>
<form onkeydown="return event.key != 'Enter';">
<div class="body">

   <h1>Absorption Spectra</h1> 

  <p>Welcome to the absorption spectra! This experiment is to look at absorption lines within a gas!</p>

  <canvas class="center" id="canvas" height="500" width="750"></canvas> <br>
  <input class="center" id="repeats" type = "number" placeholder="Number of Photons" min="0" max="20" value="15" onchange=""/> 
  <input type="button" onclick="start()" value="Start!" class="center"/>
  

  <p id="display"> </p>

  <h2>Use this slider to set the photon energy</h2>
  <div class="slidecontainer">
    <input type="range" min="1.6" max="3.5" value="2.5" step="0.1" class="slider" id="myRange">
    <h2 style="color:lightgreen;">Energy: <span id="energy"></span> eV</h2>
  </div>

  <h2>Results</p>

  <h2 style="color:lightgreen;"><span id="number"></span> <span id="finish"> </span> </h2>
  <p ><span id="prevNum1"></span> <span id="prev1"></span></p>
  <p ><span id="prevNum2"></span> <span id="prev2"></span></p>
  <p ><span id="prevNum3"></span> <span id="prev3"></span></p>
  <p ><span id="prevNum4"></span> <span id="prev4"></span></p>
  <p ><span id="prevNum5"></span> <span id="prev5"></span></p>
  <p ><span id="prevNum6"></span> <span id="prev6"></span></p>
  <p ><span id="prevNum7"></span> <span id="prev7"></span></p>
  <p ><span id="prevNum8"></span> <span id="prev8"></span></p>
  <p ><span id="prevNum9"></span> <span id="prev9"></span></p>
  <p ><span id="prevNum10"></span> <span id="prev10"></span></p>
  <p ><span id="prevNum11"></span> <span id="prev11"></span></p>
  <p ><span id="prevNum12"></span> <span id="prev12"></span></p>
  <p ><span id="prevNum13"></span> <span id="prev13"></span></p>
  <p ><span id="prevNum14"></span> <span id="prev14"></span></p>
  <p ><span id="prevNum15"></span> <span id="prev15"></span></p>
  <p ><span id="prevNum16"></span> <span id="prev16"></span></p>
  <p ><span id="prevNum17"></span> <span id="prev17"></span></p>
  <p ><span id="prevNum18"></span> <span id="prev18"></span></p>
  <p ><span id="prevNum19"></span> <span id="prev19"></span></p>
  <p ><span id="prevNum20"></span> <span id="prev20"></span></p>


</form>


</body>

<script>
    // Based on code found here: https://gist.github.com/hacknightly/fd609abe5a7e15e223a823ee6e0724c8
    let x = 375;
    let y = 250;
    var counter = document.querySelector('canvas');
    var number = 1;
    var wavelength = 0; 
    var animation = false;
    var sleeptime = 5000;

    var unlikelyEnergies = [1.9, 2.6, 2.9];

    var pAbs = 0;
    var pAbsLow = 0;
    var pAbsHigh = 0.05;

    function random(min, max) {
      return Math.random() * (max - min) + min;
    }

    function init() {
      animation = window.requestAnimationFrame(draw);
    }

    function draw() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');    
      ctx.strokeStyle = 'green';
      ctx.beginPath();
      ctx.lineWidth = 5;
      ctx.moveTo(0,300);
      ctx.lineTo(750,300);
      ctx.stroke();
      ctx.beginPath();
      ctx.lineWidth = 5;
      ctx.moveTo(0,100);
      ctx.lineTo(750,100);
      ctx.stroke();
      //ctx.strokeStyle = 'blue';
      //ctx.beginPath();
      //ctx.lineWidth = 5;
      //ctx.moveTo(300,25);
      //ctx.lineTo(450,25);
      //ctx.stroke();

      var WL = wavelengtheVConverter(document.getElementById("energy").innerHTML);
      var color = wavelengthToColor(WL);      

      ctx.strokeStyle = color;
      ctx.beginPath();
      ctx.moveTo(x, y);
      
      var pertx = 0;
      var perty = 0;

      if (y > 300 || y < 100) {
        pertx = 0;
        perty = -10;
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.lineTo(x+pertx, y+perty);
        ctx.stroke();
        animation = window.requestAnimationFrame(draw);
        x += pertx;
        y += perty;
        if (y < 25) {
          var np1 = number + 1;
          document.getElementById("number").innerHTML = np1 + ".";
          document.getElementById("finish").innerHTML = "Photon escaped!";
          if (number < parseInt(document.getElementById("repeats").value) - 1) {
            sleep(sleeptime);
            restart();
          }
        }
      } else {
        pertx = random(-15, 15);
        perty = random(-5, 2);
      
        if ((y + perty) > 300) {
          perty = random(-2,0);
        }
        if ((y + perty) < 200) {
          perty = random(-7,5);
        }
        if ((x + perty) < 0) {
          pertx = random(0,7.5);
        }
        if ((x + perty) > 750) {
          pertx = random(-7.5,0);
        }

        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.lineTo(x+pertx, y+perty);
        ctx.stroke();

        if (Math.random() < pAbs) {
          var np1 = number + 1;
          document.getElementById("number").innerHTML = np1 + ".";
          document.getElementById("finish").innerHTML = "Photon absorbed!";
          if (number < parseInt(document.getElementById("repeats").value) - 1) {
            sleep(sleeptime);
            restart();
          } else {
            return;
          }
        } else {
          x += pertx;
          y += perty;
          animation = window.requestAnimationFrame(draw);
        }
      }
    }
    
    function start() {
      if (animation) {
  	  window.cancelAnimationFrame(animation)
	}
	const canvas = document.getElementById('canvas');
	const context = canvas.getContext('2d');

	context.clearRect(0, 0, canvas.width, canvas.height);

	for (var i=1; i < parseInt(document.getElementById("repeats").value); ++i) {
	  s1 = "prev" + String(i);
	  s2 = "prevNum" + String(i);
        	  document.getElementById(s1).innerHTML = "";
        	  document.getElementById(s2).innerHTML = "";
  	}

	var slider = document.getElementById("myRange");
	if (unlikelyEnergies.includes(parseFloat(slider.value))) {
 	  pAbs = pAbsHigh;
        	} else {
    	  pAbs = pAbsLow;
     	}

         x = 375;
         y = 500;
         number = 0;
         //document.getElementById("display").innerHTML = 0;
         document.getElementById("number").innerHTML = "";
         document.getElementById("finish").innerHTML = "";
         init();
    }

    function restart() {
        	if (animation) {
  	  window.cancelAnimationFrame(animation)
	}
	number++;
	const canvas = document.getElementById('canvas');
	const context = canvas.getContext('2d');

	context.clearRect(0, 0, canvas.width, canvas.height);

	for (var i = 1; i < parseInt(document.getElementById("repeats").value); ++i) { 
        	  k = parseInt(document.getElementById("repeats").value) - i;
  	  j = k + 1;
	  s1 = "prev" + String(j); 
	  s2 = "prev" + String(k); 
	  s3 = "prevNum" + String(j); 
	  s4 = "prevNum" + String(k);
	  document.getElementById(s1).innerHTML = document.getElementById(s2).innerHTML; 
	  document.getElementById(s3).innerHTML = document.getElementById(s4).innerHTML;
	}   	

	var slider = document.getElementById("myRange");
	if (unlikelyEnergies.includes(parseFloat(slider.value))) {
 	  pAbs = pAbsHigh;
        	} else {
    	  pAbs = pAbsLow;
     	}


       	document.getElementById("prev1").innerHTML = document.getElementById("finish").innerHTML;
        	document.getElementById("prevNum1").innerHTML = String(number) + ".";        
	//document.getElementById("number").innerHTML = String(number) + ".";
	x = 375;
	y = 500;
	draw();
    }
    
    var slider = document.getElementById("myRange");
    var output = document.getElementById("energy");
    output.innerHTML = slider.value;

    slider.oninput = function() {
      output.innerHTML = this.value;
    }

    function wavelengtheVConverter(energy) {
      h = 6.626e-34;
      c = 3e8;
      joules = energy*1.602e-19;
      wavelength = parseInt((h*c)/(joules) * 1e9);
      return wavelength;
    }

    // takes wavelength in nm and returns an rgba value
    // Taken from: https://scienceprimer.com/javascript-code-convert-light-wavelength-color
    function wavelengthToColor(wavelength,count) {
        var r,
            g,
            b,
            alpha,
            colorSpace,
            wl = wavelength,
            gamma = 1;
 
 
        if (wl >= 350 && wl < 440) {
            R = -1 * (wl - 440) / (440 - 350);
            G = 0;
            B = 1;
       } else if (wl >= 440 && wl < 490) {
           R = 0;
           G = (wl - 440) / (490 - 440);
           B = 1;  
        } else if (wl >= 490 && wl < 510) {
            R = 0;
            G = 1;
            B = -1 * (wl - 510) / (510 - 490);
        } else if (wl >= 510 && wl < 580) {
            R = (wl - 510) / (580 - 510);
            G = 1;
            B = 0;
        } else if (wl >= 580 && wl < 645) {
            R = 1;
            G = -1 * (wl - 645) / (645 - 580);
            B = 0.0;
        } else if (wl >= 645 && wl <= 780) {
            R = 1;
            G = 0;
            B = 0;
        } else {
            R = 0;
            G = 0;
            B = 0;
        }
 
        // intensty is lower at the edges of the visible spectrum.
        //if (wl > 780 || wl < 380) {
        //    alpha = 0;
        //} else if (wl > 700) {
        //    alpha = (780 - wl) / (780 - 700);
        //} else if (wl < 420) {
        //    alpha = (wl - 380) / (420 - 380);
        //} else {
        //    alpha = 1;
        //}
 
        alpha = 1;
 
        colorSpace = "rgb(" + (R * 100) + "%," + (G * 100) + "%," + (B * 100) + "%)";

        // colorSpace is an array with 5 elements.
        // The first element is the complete code as a string.  
        // Use colorSpace[0] as is to display the desired color.  
        // use the last four elements alone or together to access each of the individual r, g, b and a channels.  
       
        return colorSpace;
       
    }

    function componentToHex(c) {
      var hex = c.toString(16);
      return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
      return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }

    function sleep(milliseconds) {
      var start = new Date().getTime();
      for (var i = 0; i < 1e7; i++) {
      if ((new Date().getTime() - start) > milliseconds){
        break;
        }
      }
    }

  </script>

</html>
