<!DOCTYPE html>
<html>
<link rel="stylesheet" href="../ALEX.css">

<meta http-equiv='cache-control' content='no-cache'> 
<meta http-equiv='expires' content='0'> 
<meta http-equiv='pragma' content='no-cache'>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.plot.ly/plotly-2.11.1.min.js"></script>
<script src="plotly-2.11.1.min.js"></script>

<head>
<style>
body {
  background-image:url('Nebula.jpeg');
  background-size:cover;
  background-attachment: fixed; 
  background-size:fill; 
}

* {
  box-sizing:border-box;
}
.column {
  float:left;
  width:50%;
}

.row:after {
  contents: "";
  display: table;
  clear: both;
}

.column3 {
  float:left;
  width:33%;
}

h1 {
  color:green;
}

h2 {
  color:green;
}

p, a {
  color:darkgreen;
}

.slidecontainer {
  width: 100%;
}

.slider {
  -webkit-appearance: none;
  border: 2px darkgreen solid;
  width: 100%;
  height: 25px;
  background: darkgreen;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover {
  opacity: 1;
  background:darkgreen;
  border: 2px lightgreen solid;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  cursor: pointer;
  background:white;
}

.slider::-moz-range-thumb {
  width: 35px;
  height: 35px;
}

input {
  color:lightgreen;
  font-size:min(max(18pt, 2vw), 22pt);
  border:2px darkgreen solid;
}

input:hover {
  color:darkgreen;
  background:lightgreen;
}

input::placeholder {
  color:lightgreen;
}

input:hover::placeholder {
  color:darkgreen;
}

.AstrSpectroscopy {
  border: 1vw solid darkgreen;
  background-color:lightgreen;
  border-radius:5px;
  padding:10px;
  margin-top:10px;
  margin-bottom:10px;
  max-width:120ch;
}

</style>

<script src="https://cdn.plot.ly/plotly-2.11.1.min.js"></script>
<script src="plotly-2.11.1.min.js"></script>

</head>
<header>
  <title>Blackbody</title>
  <button class = "button biggerButton" onclick="SpecHome()">Main Menu</button>
</header>

<script>
  function SpecHome() {
    window.open('AstronomicalSpectroscopyII.html','_self');
  }
</script>

<body>
<div class="body">
  <div class="AstrSpectroscopy center">
    <h1>The Blackbody</h2> 


    <p>What is the peak wavelength? (Use nanometers)</p>

    <input id="MaxLambda" type = "number" placeholder="Peak Wavelength (nm)" min="100" max="1000" onchange=""/> 

  </div>

  <input type="button" onclick="plot()" value="Plot" class="center"/><br>

  <div class="AstrSpectroscopy center">
    <div class="slidecontainer">
      <p><b>Blackbody Temperature:</b> <span id="Temperature"></span> K</p>
      <input type="range" min="3000" max="30000" value="0" step="100" class="slider" id="myRange">
    
    </div>

    <div id="myPlot" style="width:100%;padding-left:0;padding-right:0%;"></div>

    <p id="counts"></p>

  </div>



</body>

<script>
var WLmin = 350;
var WLmax = 700;
var ROYGBIV = 7;
var wavelengths = new Array(ROYGBIV);
var counts = new Array(ROYGBIV);

var colors = new Array(1000);
var lamArr = new Array(1000);

var wavelengthCurve = new Array(1000);
var temperatureCurve = new Array(1000);

var slider = document.getElementById("myRange");
var output = document.getElementById("Temperature");
output.innerHTML = slider.value;

slider.oninput = function() {
  output.innerHTML = this.value;
  changeTemp();
}

var layout= {
  plot_bgcolor:"black",
  paper_bgcolor:"black",
  yaxis: {
    autorange: true,
    showgrid: false,
    zeroline: false,
    showline: false,
    autotick: true,
    ticks: '',
    showticklabels: false
  },
  bargap:0,
  xaxis: {
    tickcolor: "white",
    tickfont: {color:"white"},
    title: "Wavelength (nm)",
    titlefont: {color:"white"},
    tickvals:[1e-7,2e-7,3e-7,4e-7,5e-7,6e-7,7e-7,8e-7,9e-7,10e-7],
    ticktext:[100,200,300,400,500,600,700,800,900,1000]
  },
}
 
var config = {
  modeBarButtonsToRemove: ['pan2d','lasso2d','select2d','autoScale2d','toImage','zoom2d','resetScale2d','zoomIn2d','zoomOut2d'],
  responsive:true,
  displaylogo:false,
}
function TfromLM(LambdaMax) {
  LambdaMax = LambdaMax * 1e-9;
  Tsun = 5800;
  lambdaMaxSun = 500 * 1e-9;
  var constant = Tsun * lambdaMaxSun;
  T = constant / LambdaMax;
  return T;
}

function planck(p,T,step) {
  var lambda0 = 100e-9;
  var lambdaf = 100e-8;
  step = (lambdaf - lambda0) / 1000;
  var lam = lambda0;
  h = 6.6260701e-34;
  c = 2.9979246e8;
  k = 1.380649e-23;
  for (var i=0; lam < lambdaf - step; ++i) {
    lam = lam + step;
    exp = h*c / (lam*k*T) ;
    factor = 2*h*c**2 / (lam**5);
    p[i] = factor / (Math.pow(Math.E,exp) - 1);
    lamArr[i] = lam.toPrecision(4);
    colors[i] = wavelengthToColor(lam * 1e9);
  }
  //document.getElementById("counts").innerHTML = lamArr;
  return p;
}

function pNorm(p,norm) {
  var pMax = 0;
  for (var i=0; i < 1000; ++i) {
    if (p[i] > pMax) {
      pMax = p[i];
    }
  }
  for (var i=0; i < 1000; ++i) {
    p[i] = p[i] * norm / pMax;
  }
  return p;
}

function pNoise(p) {
  // Use after norm
  for (var i=0; i < 1000; ++i) {
    p[i] = p[i] * 0.925 - generateGaussian(0,0.25);
  }
  return p;
}

function addAbsorptionLine(p) {
  var lines = [393e-9,397e-9,410e-9,423e-9,431e-9,434e-9,486e-9,517e-9,527e-9,590e-9,656e-9,686e-9];
  var place = 0;
  for (var i=0; i < lines.length; ++i) {
    for (var j=0; j < lamArr.length; ++j) {
      diff = Math.abs(lines[i] - lamArr[j])
      if (diff == 0) {
        p[j] = p[j] * 0.75;
      } else if (diff < 4e-9) {
        p[j] = p[j] * Math.abs(1 - (Math.abs(4 - diff*1e9) / 12 ) );
        //document.getElementById("counts").innerHTML = Math.abs(1 - Math.abs(4 - diff*1e9) );
      }
    }
  }
  // document.getElementById("counts").innerHTML = smallDiffs;
}

function generateGaussian(mean,std){
  var _2PI = Math.PI * 2;
  var u1 = Math.random();
  var u2 = Math.random();
  
  var z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(_2PI * u2);
  var z1 = Math.sqrt(-2.0 * Math.log(u1)) * Math.sin(_2PI * u2);

  return z1 * std + mean;
}

//document.getElementById("counts").innerHTML = generateGaussian(0,1);

function changeTemp() {
  LambdaMax = parseInt(document.getElementById("MaxLambda").value) ;

  temperatureCurve = planck(temperatureCurve,parseInt(output.innerHTML),0.1e-9);
  temperatureCurve = pNorm(temperatureCurve,10);

  var trace1 = {
    x:lamArr,
    y:temperatureCurve,
    marker: {color:'green'},
    type:'scatter',
    showlegend:false
  }
  //Colored Wavelength Curve
  var trace3 = {
    x:lamArr,
    y:wavelengthCurve,
    marker: {color:colors},
    type:'bar',
    showlegend:false,
    bargap:0
    //width:9.1e-9
  }

  var data = [trace1,trace3]
  Plotly.newPlot("myPlot", data, layout, config);
}

function plot() {
  LambdaMax = parseInt(document.getElementById("MaxLambda").value) ;

  temperatureCurve = planck(temperatureCurve,parseInt(output.innerHTML),0.1e-9);
  temperatureCurve = pNorm(temperatureCurve,10);
  T = TfromLM(LambdaMax);
  wavelengthCurve = planck(wavelengthCurve,T,1e-10);
  wavelengthCurve = pNorm(wavelengthCurve,10);
  wavelengthCurve = pNoise(wavelengthCurve);
  addAbsorptionLine(wavelengthCurve);
  newlamArr = lamArr * 1e9
  //Green Temperature Curve
  var trace1 = {
    x:lamArr,
    y:temperatureCurve,
    marker: {color:'green'},
    type:'scatter',
    showlegend:false
  }
  //Colored Wavelength Curve
  var trace3 = {
    x:lamArr,
    y:wavelengthCurve,
    marker: {color:colors},
    type:'bar',
    showlegend:false,
    bargap:0
    //width:9.1e-9
  }
  
  var data = [trace1,trace3]
  Plotly.newPlot("myPlot", data, layout, config);
}

Plotly.newPlot("myPlot", data, layout, config);

// takes wavelength in nm and returns an rgba value
// Adopted from: https://scienceprimer.com/javascript-code-convert-light-wavelength-color
function wavelengthToColor(wavelength) {
  var r,
      g,
      b,
      alpha,
      colorSpace,
      wl = wavelength,
      gamma = 1;


  if (wl >= 350 && wl < 440) {
      R = -1 * (wl - 440) / (440 - 350);
      G = 0;
      B = 1;
  } else if (wl >= 440 && wl < 490) {
      R = 0;
      G = (wl - 440) / (490 - 440);
      B = 1;  
  } else if (wl >= 490 && wl < 510) {
      R = 0;
      G = 1;
      B = -1 * (wl - 510) / (510 - 490);
  } else if (wl >= 510 && wl < 580) {
      R = (wl - 510) / (580 - 510);
      G = 1;
      B = 0;
  } else if (wl >= 580 && wl < 645) {
      R = 1;
      G = -1 * (wl - 645) / (645 - 580);
      B = 0.0;
  } else if (wl >= 645 && wl <= 780) {
      R = 1;
      G = 0;
      B = 0;
  } else {
      R = 0;
      G = 0;
      B = 0;
  }

  // intensty is lower at the edges of the visible spectrum.
  if (wl > 780 || wl < 350) {
      alpha = 0;
  } else if (wl > 700) {
      alpha = (780 - wl) / (780 - 700);
  } else if (wl < 420) {
      alpha = (wl - 350) / (420 - 350);
  } else {
      alpha = 1;
  }
  //alpha = 1;

  colorSpace = "rgba(" + (R * 100) + "%," + (G * 100) + "%," + (B * 100) + "%, " + alpha +")";

  // colorSpace is an array with 5 elements.
  // The first element is the complete code as a string.  
  // Use colorSpace[0] as is to display the desired color.  
  // use the last four elements alone or together to access each of the individual r, g, b and a channels.  
  
  return colorSpace;
    
}
</script>

</html>